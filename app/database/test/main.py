import os, sys
import time
import numpy as np

MAIN_DIR_PATH = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
if __name__ == "__main__":
    sys.path.append(MAIN_DIR_PATH)

from database import DatabaseElasticsearch, DatabaseRelationalPostgreSQL
from constants import TMP_DIR, CONFIG_DIR


workspace_name = "qsdsx"

if "elastic" in sys.argv:
    api_es = DatabaseElasticsearch()
    api_es.drop_index(index_name="chunks") # Dropping index and recreating in the same exec creates invisible conflicts.
    time.sleep(2)
    api_es.create_index(index_name="workspaces", mapping_file=os.path.join(CONFIG_DIR, "index-chunks.json"))

    documents = api_es.query_data(index_name="workspaces")
    # print(documents)

    test_vect = [-0.06587695330381393, 0.03964429348707199, 0.046370524913072586, -0.03967520594596863, 0.007183857727795839, -0.025141770020127296, 0.065950408577919, 0.08760033547878265, -0.005164029076695442, -0.026005057618021965, -0.055012188851833344, -0.02865481935441494, 0.007793195080012083, -0.01061872486025095, -0.1575293242931366, -0.057242389768362045, -0.09292563796043396, -0.020917555317282677, 0.06465393304824829, -0.11214765161275864, 0.03231346607208252, 0.012771222740411758, 0.04860043525695801, -0.021244142204523087, -0.025083106011152267, 0.05316177383065224, -0.019228577613830566, -0.003292657667770982, 0.05531405285000801, -0.08898627758026123, 0.022214747965335846, 0.08694615215063095, -0.021538563072681427, -0.031222492456436157, 0.022124705836176872, 0.03960038349032402, -0.021089842543005943, -0.023059219121932983, 0.04155919328331947, -0.004642377141863108, -0.07228975743055344, -0.044235214591026306, -0.021817876026034355, -0.029607350006699562, 0.027724487707018852, 0.05318981409072876, -0.014047526754438877, -0.006824189331382513, -0.05065453052520752, -0.0067573306150734425, -0.05789640173316002, -0.10349688678979874, 0.05568426474928856, -0.08987560123205185, -0.03286714106798172, 0.04429018497467041, -0.005305387079715729, -0.09504837542772293, 0.058322686702013016, 0.039796821773052216, 0.021344289183616638, 0.010337925516068935, -0.04717737436294556, 0.029892323538661003, 0.058912813663482666, 0.029233137145638466, 0.029884230345487595, 0.07425907254219055, -0.058903396129608154, -0.07304035127162933, -0.001666101859882474, -0.07553700357675552, 0.026316413655877113, 0.0026754173450171947, -0.029679689556360245, 0.01672961190342903, 0.02507968805730343, 0.045263804495334625, 0.010784640908241272, -0.04584534838795662, -0.0324397087097168, -0.049910932779312134, 0.07130500674247742, 0.011971750296652317, -0.04224904254078865, 0.04495590180158615, 0.04966457933187485, 0.009563631378114223, 0.027121132239699364, -0.006315554957836866, -0.0934734046459198, -0.021987849846482277, -0.06724641472101212, 0.07679461687803268, -0.07415290921926498, 0.06096608191728592, -0.016122572124004364, -0.04838623106479645, 0.04759485274553299, 0.06441321969032288, -0.040174081921577454, 0.008769110776484013, 0.055153850466012955, -0.029404425993561745, -0.06408529728651047, -0.08336741477251053, 0.04576656594872475, 0.0025564793031662703, 0.027513699606060982, -0.04103577509522438, 0.041012659668922424, -0.027251051738858223, -0.07747843861579895, -0.006713013630360365, 0.03688843920826912, -0.0684196799993515, -0.02629583515226841, -0.019825300201773643, 0.02443121187388897, -0.13231384754180908, 0.02831181511282921, -0.003251748625189066, -0.044345587491989136, -0.03760321065783501, -0.10786741226911545, 0.028114203363656998, -0.04396311938762665, 1.083323765305915e-32, 0.010914104990661144, 0.04630231484770775, -0.02069343999028206, 0.0385017991065979, 0.03622507303953171, -0.0070818648673594, -0.022075381129980087, 0.04549784958362579, -0.11836688220500946, -0.001176071004010737, -0.00810924544930458, -0.02777753211557865, -0.08556314557790756, 0.06761940568685532, 0.04172030836343765, -0.12011611461639404, 0.021213823929429054, 0.05099593475461006, -0.00571448402479291, -0.09560415148735046, -0.05646580457687378, 0.04943340644240379, 0.018023382872343063, 0.009278256446123123, 0.11045049875974655, 0.09255246818065643, 0.02151188999414444, -0.04581882432103157, 0.06374385952949524, 0.048525359481573105, 0.004661664832383394, 0.08908567577600479, -0.012187836691737175, -0.04872111976146698, 0.015417140908539295, -0.05464516952633858, -0.06664751470088959, -0.07800096273422241, -0.04155346378684044, 0.0610010027885437, 0.07395587116479874, 0.021317943930625916, -0.0057573989033699036, -0.013281051069498062, -0.015459954738616943, 0.0335029736161232, 0.09338507056236267, 0.0289594829082489, 0.11604678630828857, -0.03398458659648895, -0.10352400690317154, 0.044098444283008575, -0.0425482876598835, -0.048565689474344254, 0.10650449991226196, 0.0012080557644367218, -0.004852721933275461, 0.025387350469827652, 0.03854953870177269, 0.009902256540954113, -0.0017777151660993695, 0.10835745185613632, -0.022755801677703857, -0.03458689525723457, 0.07731835544109344, 0.0984058827161789, 0.03716236352920532, 0.018498728051781654, 0.059268251061439514, -0.008316359482705593, -0.11470682919025421, -0.000980329466983676, 0.011056452989578247, 0.07865338772535324, 0.07445428520441055, 0.037008944898843765, 0.010039465501904488, 0.04292016476392746, -0.025765730068087578, -0.01231434103101492, -0.08990038186311722, 0.017081191763281822, -0.006698925979435444, -0.07617706060409546, 0.06734751164913177, -0.013760038651525974, 0.03161077946424484, 0.05023190379142761, 0.015515301376581192, 0.037933818995952606, -0.017779409885406494, -0.02476619929075241, -0.005125902127474546, 0.04799297824501991, -0.04736635833978653, -1.1339138830242384e-32, -0.017330676317214966, -0.039795055985450745, -0.13614052534103394, 0.03662465885281563, 0.0407584086060524, -0.03583338111639023, -0.017301984131336212, 0.05604133754968643, 0.02451949380338192, 0.004170313011854887, 0.09641341865062714, 0.011123868636786938, -0.002211939310654998, -0.032867249101400375, -0.11676032096147537, -0.02992379665374756, 0.08691713213920593, -0.06965650618076324, -0.07049864530563354, -0.03957387059926987, 0.012611896730959415, 0.034755852073431015, 0.010888694785535336, 0.0055372994393110275, 0.01694282330572605, 0.07082485407590866, 0.0847964808344841, 0.025847163051366806, -0.06683526933193207, 0.043248485773801804, -0.04552362486720085, -0.0023068117443472147, -0.003220821963623166, 0.0010070409625768661, -0.022899625822901726, -0.04202309623360634, 0.054153382778167725, -0.06652747839689255, 0.006251263897866011, -0.007467197719961405, -0.015010098926723003, 0.03542251139879227, 0.011463654227554798, 0.03932393342256546, -0.0074419123120605946, -0.07908575236797333, -0.054246533662080765, -0.04147111251950264, 0.05274265632033348, -0.027369458228349686, 0.010324561037123203, -0.01517280749976635, 0.06349904835224152, -0.12932135164737701, -0.012110840529203415, -0.0716714859008789, 0.01878328062593937, -0.02159513719379902, 0.0017821218352764845, 0.0012237608898431063, 0.10107243806123734, -0.029426053166389465, 0.04926483705639839, 0.011052295565605164, 0.03184420242905617, -0.045025553554296494, -0.07283826172351837, 0.021814467385411263, -0.0547105111181736, 0.004526958335191011, 0.0883980393409729, -0.05862801522016525, 0.010728150606155396, 0.02093447558581829, -0.023678971454501152, -0.04383029416203499, 0.019749369472265244, 0.0653371810913086, -0.037665244191884995, -0.008330637589097023, 0.00028321106219664216, 0.05488963425159454, -0.024540668353438377, 0.02777758054435253, 0.03556836396455765, -0.03696243464946747, -0.08129198104143143, -0.018861234188079834, 0.009595734067261219, 0.017293892800807953, 0.03185968101024628, 0.018529091030359268, 0.008131557144224644, 0.10612082481384277, -0.014554029330611229, -5.706340644451302e-8, 0.015741484239697456, 0.003773567732423544, 0.02426948770880699, -0.09646066278219223, -0.00160249846521765, 0.0033821105025708675, -0.013349153101444244, -0.07699887454509735, -0.04322696104645729, -0.10156404227018356, -0.012256702408194542, 0.059078946709632874, -0.010472238063812256, 0.1288972795009613, -0.021519163623452187, 0.056047260761260986, -0.04380694031715393, 0.07060026377439499, -0.04843703657388687, -0.06696683913469315, 0.03306024894118309, -0.0327770859003067, 0.07703354209661484, -0.008344571106135845, -0.07568281888961792, 0.02036224491894245, 0.007689652498811483, -0.07582617551088333, 0.032548271119594574, -0.08935922384262085, -0.019278492778539658, 0.09320445358753204, 0.035337839275598526, 0.027958443388342857, 0.02420422062277794, 0.0780947133898735, -0.037876732647418976, 0.01019316352903843, -0.09599210321903229, 0.07906094938516617, 0.060275088995695114, -0.00538833811879158, -0.005696877837181091, 0.03323448449373245, -0.010393631644546986, 0.004107360728085041, 0.017558380961418152, -0.034607503563165665, -0.028824277222156525, 0.0046671247109770775, -0.030088109895586967, -0.017142802476882935, 0.010337445884943008, 0.06494996696710587, -0.0033335990738123655, 0.04885878413915634, -0.006819583009928465, -0.02318565547466278, -0.030324479565024376, -0.02360135316848755, -0.02114451862871647, -0.020878111943602562, 0.09687218815088272, 0.019716808572411537]

    fetch = api_es.similarity_search(index_name="chunks", query_vector=test_vect, k=5, 
                                    must_pairs=[{"workspace_name": "test"}])
    [print(doc["_source"]["chunk"]["metadata"]["file_key"], doc["_source"]["chunk"]["position"]) for doc in fetch]

if "postgre" in sys.argv:
    api_app_db = DatabaseRelationalPostgreSQL()
    api_app_db.drop_schema(schema_name="hyper-rag")
    api_app_db.use_schema(schema_name="hyper-rag")
    api_app_db.execute_file(file_path=os.path.join(CONFIG_DIR, "postgre_setup.sql"))   
    api_app_db.send_data(table_name="users", 
                          user_name="jdoe", 
                          user_password="password",
                          user_apikey="not-a-key",
                          user_email="jdoe@example.com",
                          share_workspaces=True)
    print(api_app_db.query_data(SELECT="*", FROM="users"))